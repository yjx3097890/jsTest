<!DOCTYPE html>
<html>
  <head>
    <title></title>
  </head>
  <style media="screen">
    svg {
      font: 10px sans-serif;
    }

    .axis path, .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }


    .x.axis line {
      stroke: #fff;
      stroke-opacity: .8;
    }

    .y.axis path {
      stroke: black;
    }

    .axis path {
      stroke: none;
    }
    .bar rect {
      fill: steelblue;
    }
    .bar:hover rect {
    fill: brown;
  }

.bar text {
  text-anchor: end
}
  </style>
  <body>
<div class="chart">
</div>
<script src="d3.js" charset="utf-8"></script>
<script type="text/javascript">

var margin = {left: 40, top: 20, right: 40, bottom: 10};
var width = 960, height= 300 - margin.top - margin.bottom;
//var f = d3.format('1<-$09,.3%');
//console.log(f(3421.2))
var f = d3.format('.1%');
var svg = d3.select('.chart')
  .append('svg')
  .attr('width', width + margin.left + margin.right)
  .attr('height', height + margin.top + margin.bottom)
  .style('margin-left', '100px').
  append('g')
  .attr('transform', 'translate('+margin.left+','+ margin.top+')'); //为刻度值留出空间

var x = d3.scale.linear().range([0, width]);
var y = d3.scale.ordinal().rangeRoundBands([0, height], 0.1);



var xAxis = d3.svg.axis().scale(x)

.orient('top')  //刻度值相对于轴的方向
.tickSize(-height - margin.bottom)  // 轴宽度， 图中的白线
.tickFormat(f);//刻度值格式
svg.append('g')
 .attr('class', 'x axis');

//y轴
var yg = svg.append('g').attr('class', 'y axis')
.append('line').attr('class', 'domain')
.attr('y2', height);

var states, ages;
d3.csv('states-age.csv', function (data) {
  states = data;

  ages = d3.keys(states[0]).filter(function (k) {
    return k !== 'State' && k !== 'Total';
  });

  states.forEach(function (state) {
    ages.forEach(function (age) {
      state[age] = state[age] / state['Total'];
    })
  });



  draw(ages[0]);

  setInterval(function () {
    var i=Math.floor(Math.random() * 10 );
    var a = ages[i];
    d3.transition()
        .duration( 750)
        .each(function () {
          draw(a);
          });
  }, 2000);

});

function draw(age) {
  var top = states.sort(function(a, b) {
    return b[age] - a[age];    //降序
  }).slice(0,10);

  y.domain(top.map(function (item) {
    return item.State;
  }));

  var bar = svg.selectAll('.bar').data(top, function (d) {
    return d.State;
  });

  x.domain( [0, top[0][age]]);

  var barEnter = bar.enter().insert('g', '.axis')
  .attr('class', 'bar')
  .attr('transform', function(d) {
      return 'translate('+0+','+ (y(d.State) + height)+')';   //动画从最下面过度
  })
  .style('fill-opacity', 0);

    barEnter.append('rect').
    attr('width', function (d) {
        return x(d[age]);
    })
    .attr('height', y.rangeBand());

    barEnter.append('text')
    .attr('class', 'label')
    .attr('x', -3)
    .attr('y', y.rangeBand()/2)
    .attr("dy", ".35em")
    .text(function (d) {
      return d['State'];
    });


    barEnter.append('text')
    .attr('class', 'value')
    .attr('x', function (d) {
      return x(d[age]) -3;
    })
    .attr('y', y.rangeBand()/2)
    .attr('dy', '0.35em');



    var barUpdate = bar.transition()   //这个过度会作用于enter(), 因为bar已被enter集合扩展
    .attr('transform', function (d) {
      return 'translate(0,'+ y(d.State) +')';
    })
    .style('fill-opacity', 1);

    barUpdate.select('rect').attr('width', function (d) {
      return x(d[age])
    });

    barUpdate.select('.value')
    .attr("x", function(d) {
      return x(d[age]) - 3;
    })
    .text(function(d) {
      return f(d[age]);
      });

      var barExit = bar.exit().transition()
      .remove();

      svg.select('.x.axis').transition().call(xAxis);



}




</script>
  </body>
</html>

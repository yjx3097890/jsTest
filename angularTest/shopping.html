<html >
<head>
	<meta charset="utf-8"/>
  <script src="angular/angular.js"></script>
  <script >
	var myapp = angular.module("myapp", []);
	
	myapp.factory('Items', function () {
		var items = {};
		items.query = function () {
			return [
			  {title: 'Paint pots', quantity: 8, price: 3.95},
			{title: 'Polka dots', quantity: 17, price: 12.95},
			{title: 'Pebbles', quantity: 5, price: 6.95}
			];
		}
		return items;
	});
	
	myapp.filter('UpperCase', function () {
	
		return function (text) {
			var words = text.split(' ');
			words.forEach(function (word, i) {
				words[i] = word.substring(0,1).toUpperCase() + word.slice(1);
			});
			return words.join(' ');
		};
	});
	
    myapp.controller("CartController", function ($scope, Items) {
        $scope.items = Items.query();
		$scope.title = 'my shopping cart';
        $scope.remove = function (index) {
			$scope.items.splice(index, 1); 
		};
		
		$scope.bill = {
			discount: 0,
		};
		$scope.totalCart = function () {
			var total = 0;
			$scope.items.forEach(function (item) {
				total += item.price * item.quantity;
			});
			
			return total;
		};
		
		$scope.subTotal = function () {
			return $scope.totalCart() - $scope.bill.discount;
		};
		function caculateDis(newVal, oldVal, scope) {
			$scope.bill.discount = newVal>100? 10: 0;
		}
		//$scope.$watch($scope.totalCart, caculateDis);
		$scope.$watch('totalCart()', caculateDis);
		
    });

	
	//不起作用，一个页面只能有一个module？？？？？？？？？？？
	var viewapp = angular.module('viewapp', ['myapp']);
	viewapp.controller('ViewController', function ($scope) {
		console.log(myapp); 
		// $scope.items = myapp.items;
	});
	
  </script>
</head>
<body >
<div ng-app="myapp" ng-controller="CartController">
	<h2>{{title | UpperCase}}</h2>
  <div ng-repeat="item in items">
		<span >{{item.title}} </span>
		<input ng-model='item.quantity'>
		<span>{{item.price | currency}}</span>
		<span> {{item.quantity * item.price | currency}}</span>
		<button ng-click="remove($index)">remove</button>
		
  </div>
		<div>Total: {{totalCart() | currency}}</div>
		<div>折扣: {{bill.discount | currency}}</div>
		<div>支付: {{subTotal() | currency}}</div>
		
</div>
	
<div ng-app="viewapp" ng-controller="ViewController">
	<div ng-repeat="item in items">
		<span >{{item.title}} </span>
  </div>
</div>	
 </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>update things</title>
    <style>
        body { margin: 0; }
        canvas { width: 100%; height: 100% }
    </style>
</head>
<body>
<div id="container"></div>
<script src="85/three.js"></script>
<script src="85/Detector.js"></script>
<script src="85/examples/js/loaders/collada/Animation.js"></script>
<script src="85/examples/js/loaders/collada/AnimationHandler.js"></script>
<script src="85/examples/js/loaders/collada/KeyFrameAnimation.js"></script>
<script src="85/examples/js/loaders/ColladaLoader.js"></script>
<script>

    let scene;
    let camera;
    let renderer;
    let cube;
    let animations;
    let kfAnimations = [ ];
    let kfAnimationsLength = 0;
    let lastTimestamp = 0;
    let progress = 0;

    const init =  function (callback) {
         scene = new THREE.Scene();
         camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        camera.lookAt(new THREE.Vector3());


        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );



        const loader = new THREE.ColladaLoader();

        loader.options.upAxis = 'Y';
        loader.load(
            // resource URL
            './moveCube.dae',
            // Function when resource is loaded
            function ( collada ) {
                cube = collada.scene;
               cube.rotation.set(-Math.PI/2, 0, -Math.PI/2);
                cube.scale.set(0.2, 0.2, 0.2);
                animations = collada.animations;
                kfAnimationsLength = animations.length;

                // KeyFrame Animations
                for ( let i = 0; i < kfAnimationsLength; ++i ) {
                    let animation = animations[ i ];
                    let kfAnimation = new THREE.KeyFrameAnimation( animation );
                    kfAnimation.timeScale = 1;
                    kfAnimations.push( kfAnimation );
                }


                scene.add( cube);
                start();
                callback && callback(lastTimestamp);
            },
            // Function called when download progresses
            function ( xhr ) {
                console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
            }
        );



    };

    function start() {
        for ( let i = 0; i < kfAnimationsLength; ++i ) {
            let animation = kfAnimations[i];
            for ( let h = 0, hl = animation.hierarchy.length; h < hl; h++ ) {
                let keys = animation.data.hierarchy[ h ].keys;
                let sids = animation.data.hierarchy[ h ].sids;
                let obj = animation.hierarchy[ h ];
                if ( keys.length && sids ) {
                    for ( let s = 0; s < sids.length; s++ ) {
                        let sid = sids[ s ];
                        let next = animation.getNextKeyWith( sid, h, 0 );
                        if ( next ) next.apply( sid );
                    }
                    obj.matrixAutoUpdate = false;
                    animation.data.hierarchy[ h ].node.updateMatrix();
                    obj.matrixWorldNeedsUpdate = true;
                }
            }
            animation.loop = false;
            animation.play();
        }
    }


    const animate = function (timestamp) {
        let frameTime = ( timestamp - lastTimestamp ) * 0.001;  //s
        if ( progress >= 0 && progress < 8 ) {
            for ( let i = 0; i < kfAnimationsLength; ++i ) {
                kfAnimations[ i ].update( frameTime );
            }
        } else if ( progress >= 8 ) {
            for ( let i = 0; i < kfAnimationsLength; ++i ) {
                kfAnimations[ i ].stop();
            }
            progress = 0;
            start();
        }

        progress += frameTime;
        lastTimestamp = timestamp;

        renderer.render( scene, camera );
        requestAnimationFrame( animate );
    };

    if (Detector.webgl) {
        init(animate);

    } else {
        let warning = Detector.getWebGLErrorMessage();
        document.getElementById('container').appendChild(warning);
    }

</script>
</body>
</html>
<!DOCTYPE html>
<html>
		<head>
            <meta charset="utf-8" />
            <title>text particle system
            </title>
        </head>
    <body>
    	<canvas id="canvas" width="800" height="500" style="border:solid 1px #aaaaaa; background-color:#000"></canvas>
        <label for="text">请输入一个文字：</label><input type="text" id="text"  />
    	<script type="text/javascript" src="Vector2.js"></script>
    	<script type="text/javascript" src="ball.js"></script>
    	<script type="text/javascript" src="wind-all-0.7.3.js"></script>
    	<script type="text/javascript" src="JSLINQ.js"></script>

        <script type="text/javascript">
            var canvas = document.getElementById("canvas"),
                context = canvas.getContext("2d"),
            	balls = [], ball,
                 dif = 25,
                    ps,
                 i, r= 3,
                  text = "王",
            input = document.getElementById("text");


            input.value = text;
            ps = drawText(text, new Vector2(200, 10), 200);
            balls = initBalls(ps);
		   	var animate = eval(Wind.compile("async", function () {

         		while (true) {
         			context.clearRect(0,0,canvas.width, canvas.height);
                    for (i=balls.length-1; i>=0; i--) {
                        ball = balls[i];
                        ball.draw(context, "#ff0000");
                        ball.move(1/dif);
                         if(ball.hasImpactSide(canvas, {down:true})) {
                             if (ball.velocity.y >0) {
                                ball.velocity.y *= -0.7;
                             }
                             ball.position.y = canvas.height - ball.radius;
                         }
                    }
         			$await(Wind.Async.sleep(1000/dif));
                    if( text !== input.value ){
         			    context.clearRect(0,0,canvas.width, canvas.height);
                        text = input.value;
                        ps = drawText(text, new Vector2(200, 10), 200);
                        balls = initBalls(ps);
                    }
         		}
         	}));
           
            animate().start();

         canvas.addEventListener("click", function () {
             var i, ball;
             for (i=balls.length -1;i>=0;i--) {
                 ball = balls[i];
                 ball.velocity.y = randomNum(500,1000);
                 ball.velocity.x = randomNum(-50,50);
                 ball.acceleration.y = 1000;
             }
         }, false );

        function drawText(text, position, size) {
            var positions =[] , i, j, data;
            context.clearRect(position.x, position.y, size, size);
            context.font = "bolder " +size+ "px 宋体";
            context.textBaseline = "top";
            context.fillStyle = "#ffffff";
            context.fillText(text, position.x, position.y);

            for (i=position.x + size -1; i >= position.x; i-=2*r){
                for (j=position.y + size -1; j >= position.y; j-=2*r) {
                    data = context.getImageData(i,j,1,1);
                    if (data.data[0] > 254) {
                        positions.push(new Vector2(i, j));
                    }
                }
            }
            return positions;
        }

         function initBalls(positions) {
            var balls =[], ball;
            for (i = positions.length - 1; i>=0;i--) {
                ball = new Ball(positions[i], r);
                balls.push(ball);
            }
            return balls;
        }

  		function randomColor() {
           var arrHex = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"]; var strHex = "#";
           var index;
           for (var i = 0; i < 6; i++) {
               index = Math.round(Math.random() * 15);
               strHex += arrHex[index];
           }
           return strHex;
       }

            function randomNum(min , max) {
                return Math.random()*(max - min) + min;
            }

        </script>
    </body>
</html>
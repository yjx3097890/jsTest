<!DOCTYPE html>
<html >
	<head>
        <meta charset="utf-8" />
		<title>Particle System</title>
        <style type="text/css">
            body {
                background-color: #000;
            }
        </style>
	</head>
    <body>
    	<canvas id="canvas" width="1300" height="600" style="border:1px solid #d3d3d3"></canvas>
       <script type="text/javascript" src="wind-all-0.7.3.js"></script>
       <script type="text/javascript" src="Vector2.js"></script>
        <script type="text/javascript">
            var Ball = function (position, radius, velocity, acceleration) {
                this.position = ( position&&position.clone() ) || new Vector2();
                this.radius = radius || 0;
                this.velocity = ( velocity&&velocity.clone() ) || new Vector2();
                this.acceleration = ( acceleration&&acceleration.clone() ) || new Vector2();
            }
            /**
             *
             * @param context
             * @param color : {rgb: '#ffffff', a : 1}
             */
            Ball.prototype.draw = function (context, color) {
                context.beginPath();
                context.globalAlpha = (color && color.a) || 1;
                context.fillStyle = (color && color.rgb) || "#FFFFFF";
                context.arc(this.position.x, this.position.y, this.radius, 0, 2 * Math.PI);
                context.closePath();
                context.fill();
            }
            /**
             * 计算移动后的位置
             * @param time ： 移动的时间
             * @param isPolar ： 速度、加速度是否是极座标表示
             */
            Ball.prototype.move = function (time, isPolar) {
                var t = time || 0;
                if (isPolar) {
                    this.position.x += this.velocity.x * Math.cos(this.velocity.y) * t + 1 / 2 * this.acceleration.x * Math.cos(this.acceleration.y) * t * t;
                    this.position.y += this.velocity.x * Math.sin(this.velocity.y) * t + 1 / 2 * this.acceleration.x * Math.sin(this.acceleration.y) * t * t;
                    this.velocity.x += this.acceleration.x * t;
                    this.velocity.y += this.acceleration.y * t;
                }else{
                    this.position.x += this.velocity.x * t + 1 / 2 * this.acceleration.x * t * t;
                    this.position.y += this.velocity.y * t + 1 / 2 * this.acceleration.y * t * t;
                    this.velocity.x += this.acceleration.x * t;
                    this.velocity.y += this.acceleration.y * t;
                }
            }
            Ball.prototype.clone = function() {
                var obj = new Ball();
                for(var p in this) {
                    if(this.hasOwnProperty(p)) {
                        if( typeof this[p] === "object") {
                            obj[p] = arguments.callee.call(this[p]);
                        }else{
                            obj[p] = this[p];
                        }
                    }
                }
                return obj;
            };

        </script>
        <script type="text/javascript">
            var canvas, context;
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d"),
            center = new Vector2(canvas.width / 2, canvas.height / 2),
            frequency = 60;
            var balls = [], radius = 2 , i, len, color, time , delta = 0;
            var init = function () {
                var ball, i, velocity;
                for(i=0; i<500; i++) {
                    velocity = new Vector2(random(2,100), random(0, Math.PI * 2));
                    ball = new Ball(center, radius, velocity);
                    balls.push(ball);
                }
                color = {
                    rgb : randomColor(),
                    a : 1
                };
                time = canvas.height / 2 ;
            };
            var load = eval(Wind.compile("async", function () {
             
                init();
                while (delta < time) {

                    try {

                        context.globalAlpha = 1;
                        context.fillStyle = "rgba(0,0,0, 0.3)";
                        context.fillRect(0 , 0, canvas.width, canvas.height);

                        color.a = 1 - delta / time ;
                        for(i=0 , len = balls.length; i<len; i++){
                            balls[i].draw(context, color);
                            balls[i].move(1 / frequency, true);
                        }
                        delta += 100 / frequency;
                    }catch (e){
                        console.log(e);
                    }
                        $await(Wind.Async.sleep(100 / frequency));
                }

                context.globalAlpha = 1;
                context.fillStyle = "rgba(0,0,0, 0.3)";
                context.fillRect(0 , 0, canvas.width, canvas.height);

            }));
            load().start();
            
            
            function random(min, max) {
                return Math.random() * (max - min)+ min;
            }

            //随即颜色，但不为黑
            function randomColor() {
                var c = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f"],
                        color = "#",
                        i = 0,
                        random = 0;
                for(i = 0;i < 6; i++){
                    random =  Math.random() * 16;
                    color += c[Math.floor(random)];
                }
                if (color == "#000000") {
                    color = randomColor();
                }
                return color;
            }
            
        </script>
    </body>
</html>
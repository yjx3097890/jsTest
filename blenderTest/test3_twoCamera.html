<!DOCTYPE html>
<html style="width: 100%;height:  100%">
<head>
<script type="text/javascript" src="./src/b4w.js"></script>
<script type="text/javascript" src="./src/anchors.js"></script>
<script type="text/javascript" src="./src/animation.js"></script>
<script type="text/javascript" src="./src/armature.js"></script>
<script type="text/javascript" src="./src/assets.js"></script>
<script type="text/javascript" src="./src/batch.js"></script>
<script type="text/javascript" src="./src/boundings.js"></script>
<script type="text/javascript" src="./src/camera.js"></script>
<script type="text/javascript" src="./src/compat.js"></script>
<script type="text/javascript" src="./src/config.js"></script>
<script type="text/javascript" src="./src/constraints.js"></script>
<script type="text/javascript" src="./src/container.js"></script>
<script type="text/javascript" src="./src/controls.js"></script>
<script type="text/javascript" src="./src/curve.js"></script>
<script type="text/javascript" src="./src/data.js"></script>
<script type="text/javascript" src="./src/debug.js"></script>
<script type="text/javascript" src="./src/extensions.js"></script>
<script type="text/javascript" src="./src/geometry.js"></script>
<script type="text/javascript" src="./src/graph.js"></script>
<script type="text/javascript" src="./src/hud.js"></script>
<script type="text/javascript" src="./src/input.js"></script>
<script type="text/javascript" src="./src/ipc.js"></script>
<script type="text/javascript" src="./src/lights.js"></script>
<script type="text/javascript" src="./src/loader.js"></script>
<script type="text/javascript" src="./src/logic_nodes.js"></script>
<script type="text/javascript" src="./src/main.js"></script>
<script type="text/javascript" src="./src/math.js"></script>
<script type="text/javascript" src="./src/navmesh.js"></script>
<script type="text/javascript" src="./src/nla.js"></script>
<script type="text/javascript" src="./src/nodemat.js"></script>
<script type="text/javascript" src="./src/obj_util.js"></script>
<script type="text/javascript" src="./src/objects.js"></script>
<script type="text/javascript" src="./src/particles.js"></script>
<script type="text/javascript" src="./src/physics.js"></script>
<script type="text/javascript" src="./src/prerender.js"></script>
<script type="text/javascript" src="./src/primitives.js"></script>
<script type="text/javascript" src="./src/print.js"></script>
<script type="text/javascript" src="./src/reformer.js"></script>
<script type="text/javascript" src="./src/renderer.js"></script>
<script type="text/javascript" src="./src/scenegraph.js"></script>
<script type="text/javascript" src="./src/scenes.js"></script>
<script type="text/javascript" src="./src/sfx.js"></script>
<script type="text/javascript" src="./src/shaders.js"></script>
<script type="text/javascript" src="./src/subscene.js"></script>
<script type="text/javascript" src="./src/texcomp.js"></script>
<script type="text/javascript" src="./src/textures.js"></script>
<script type="text/javascript" src="./src/time.js"></script>
<script type="text/javascript" src="./src/transform.js"></script>
<script type="text/javascript" src="./src/tsr.js"></script>
<script type="text/javascript" src="./src/util.js"></script>
<script type="text/javascript" src="./src/version.js"></script>
<script type="text/javascript" src="./src/libs/gl-matrix2.js"></script>
<script type="text/javascript" src="./src/libs/gpp_parser.js"></script>
<script type="text/javascript" src="./src/libs/md5.js"></script>
<script type="text/javascript" src="./src/ext/anchors.js"></script>
<script type="text/javascript" src="./src/ext/animation.js"></script>
<script type="text/javascript" src="./src/ext/armature.js"></script>
<script type="text/javascript" src="./src/ext/assets.js"></script>
<script type="text/javascript" src="./src/ext/camera.js"></script>
<script type="text/javascript" src="./src/ext/config.js"></script>
<script type="text/javascript" src="./src/ext/constraints.js"></script>
<script type="text/javascript" src="./src/ext/container.js"></script>
<script type="text/javascript" src="./src/ext/controls.js"></script>
<script type="text/javascript" src="./src/ext/data.js"></script>
<script type="text/javascript" src="./src/ext/debug.js"></script>
<script type="text/javascript" src="./src/ext/geometry.js"></script>
<script type="text/javascript" src="./src/ext/hud.js"></script>
<script type="text/javascript" src="./src/ext/input.js"></script>
<script type="text/javascript" src="./src/ext/lights.js"></script>
<script type="text/javascript" src="./src/ext/logic_nodes.js"></script>
<script type="text/javascript" src="./src/ext/main.js"></script>
<script type="text/javascript" src="./src/ext/material.js"></script>
<script type="text/javascript" src="./src/ext/math.js"></script>
<script type="text/javascript" src="./src/ext/nla.js"></script>
<script type="text/javascript" src="./src/ext/objects.js"></script>
<script type="text/javascript" src="./src/ext/particles.js"></script>
<script type="text/javascript" src="./src/ext/physics.js"></script>
<script type="text/javascript" src="./src/ext/rgb.js"></script>
<script type="text/javascript" src="./src/ext/scenes.js"></script>
<script type="text/javascript" src="./src/ext/screen.js"></script>
<script type="text/javascript" src="./src/ext/sfx.js"></script>
<script type="text/javascript" src="./src/ext/textures.js"></script>
<script type="text/javascript" src="./src/ext/time.js"></script>
<script type="text/javascript" src="./src/ext/transform.js"></script>
<script type="text/javascript" src="./src/ext/tsr.js"></script>
<script type="text/javascript" src="./src/ext/util.js"></script>
<script type="text/javascript" src="./src/ext/version.js"></script>
<script type="text/javascript" src="./src/addons/app.js"></script>
<script type="text/javascript" src="./src/addons/camera_anim.js"></script>
<script type="text/javascript" src="./src/addons/fps.js"></script>
<script type="text/javascript" src="./src/addons/gp_conf.js"></script>
<script type="text/javascript" src="./src/addons/gyroscope.js"></script>
<script type="text/javascript" src="./src/addons/hmd.js"></script>
<script type="text/javascript" src="./src/addons/hmd_conf.js"></script>
<script type="text/javascript" src="./src/addons/mixer.js"></script>
<script type="text/javascript" src="./src/addons/mouse.js"></script>
<script type="text/javascript" src="./src/addons/npc_ai.js"></script>
<script type="text/javascript" src="./src/addons/preloader.js"></script>
<script type="text/javascript" src="./src/addons/screenshooter.js"></script>
<script type="text/javascript" src="./src/addons/storage.js"></script>
<script type="text/javascript" src="./src/addons/ns_compat.js"></script>

</head>
<body style="width: 100%;height:  100%">
 <div id="container" style="width: 100%;height:  100%"></div>

<script type="text/javascript">
   
     document.oncontextmenu=new Function("event.returnValue=false;");
document.onselectstart=new Function("event.returnValue=false;");
  
      b4w.register("game_example_main", function(exports, require) {

var m_anim  = require("animation");
var m_app   = require("app");
var m_cfg   = require("config");
var m_main  = require("main");
var m_data  = require("data");
var m_ctl   = require("controls");
var m_cont  = require("container");
var m_input = require("input");
var m_phy   = require("physics");
var m_cons  = require("constraints");
var m_scs   = require("scenes");
var m_trans = require("transform");
var m_cam     = require("camera");
var m_camani     = require("camera_anim");
var m_mou    = require("mouse");
var m_vec3  = require("vec3");



var _character = null; 

var ROT_SPEED = 1.5;
var CAMERA_OFFSET = new Float32Array([0, 8, 3]);

exports.init = function() {
    m_app.init({
        canvas_container_id: "container",
        callback: init_cb,
        physics_enabled: true,
        show_fps: true,
        autoresize: true,
        alpha: false
    });
};

function init_cb(canvas_elem, success) {

    if (!success) {
        console.log("b4w init failure");
        return;
    }

    var load_path = "two_camera.json";
    m_data.load(load_path, load_cb);
}

function load_cb(data_id) {
    _character = m_scs.get_first_character();
    m_phy.set_character_move_type(_character, m_phy.CM_FLY);
    m_phy.set_gravity(_character, 0)
    setup_movement();
    setup_rotation();
    setup_jumping();
    setup_translation();
   
    setup_camera();
    setup_targetCamera();
}

function setup_movement() {
    var key_w     = m_ctl.create_keyboard_sensor(m_ctl.KEY_W);
    var key_s     = m_ctl.create_keyboard_sensor(m_ctl.KEY_S);
    var key_up    = m_ctl.create_keyboard_sensor(m_ctl.KEY_UP);
    var key_down  = m_ctl.create_keyboard_sensor(m_ctl.KEY_DOWN);

    var move_array = [
        key_w, key_up,
        key_s, key_down
    ];

    var forward_logic  = function(s){return (s[0] || s[1])};
    var backward_logic = function(s){return (s[2] || s[3])};

    function move_cb(obj, id, pulse) {
        if (pulse == 1) {
            switch(id) {
            case "FORWARD":
                var move_dir = 1;
               
                break;
            case "BACKWARD":
                var move_dir = -1;
                break;
            }
        } else {
            var move_dir = 0;
        }

        m_phy.set_character_move_dir(obj, move_dir, 0);

    };

    m_ctl.create_sensor_manifold(_character, "FORWARD", m_ctl.CT_TRIGGER,
        move_array, forward_logic, move_cb);
    m_ctl.create_sensor_manifold(_character, "BACKWARD", m_ctl.CT_TRIGGER,
        move_array, backward_logic, move_cb);
}

function setup_translation() {
     var key_q    = m_ctl.create_keyboard_sensor(m_ctl.KEY_Q);
    var key_e    = m_ctl.create_keyboard_sensor(m_ctl.KEY_E);

   

    function move_cb(obj, id, pulse) {
        if (pulse == 1) {
            switch(id) {
            case "LEFTWARD":
                var move_dir = 1;
               
                break;
            case "RIGHTWARD":
                var move_dir = -1;
                break;
            }
        } else {
            var move_dir = 0;
        }

        m_phy.set_character_move_dir(obj, 0, move_dir);

      
    };

    m_ctl.create_sensor_manifold(_character, "LEFTWARD", m_ctl.CT_TRIGGER,
        [key_q], null, move_cb);
    m_ctl.create_sensor_manifold(_character, "RIGHTWARD", m_ctl.CT_TRIGGER,
        [key_e], null, move_cb);
}

function setup_rotation() {
    var key_a     = m_ctl.create_keyboard_sensor(m_ctl.KEY_A);
    var key_d     = m_ctl.create_keyboard_sensor(m_ctl.KEY_D);
    var key_left  = m_ctl.create_keyboard_sensor(m_ctl.KEY_LEFT);
    var key_right = m_ctl.create_keyboard_sensor(m_ctl.KEY_RIGHT);

    var elapsed_sensor = m_ctl.create_elapsed_sensor();

    var rotate_array = [
        key_a, key_left,
        key_d, key_right,
        elapsed_sensor
    ];

    var left_logic  = function(s){return (s[0] || s[1])};
    var right_logic = function(s){return (s[2] || s[3])};

    function rotate_cb(obj, id, pulse) {

        var elapsed = m_ctl.get_sensor_value(obj, "LEFT", 4);

        if (pulse == 1) {
            switch(id) {
            case "LEFT":
                m_phy.character_rotation_inc(obj, elapsed * ROT_SPEED, 0);
                break;
            case "RIGHT":
                m_phy.character_rotation_inc(obj, -elapsed * ROT_SPEED, 0);
                break;
            }
        }
    }

    m_ctl.create_sensor_manifold(_character, "LEFT", m_ctl.CT_CONTINUOUS,
        rotate_array, left_logic, rotate_cb);
    m_ctl.create_sensor_manifold(_character, "RIGHT", m_ctl.CT_CONTINUOUS,
        rotate_array, right_logic, rotate_cb);
}

function setup_jumping() {
    var key_space = m_ctl.create_keyboard_sensor(m_ctl.KEY_SPACE);

    var jump_cb = function(obj,     id, pulse) {
        m_phy.character_jump(obj);
    }

    m_ctl.create_sensor_manifold(_character, "JUMP", m_ctl.CT_SHOT, 
        [key_space], null, jump_cb);
}

function setup_camera() {
    var camera = m_scs.get_active_camera();
     m_cons.append_semi_soft_cam(camera, _character, CAMERA_OFFSET); //镜头跟着角色动

    var main_canvas = m_cont.get_canvas();
    var mouse_zoom = m_ctl.create_mouse_wheel_sensor(main_canvas);

    var zoom_cb = function (obj, id, pulse) {

        if (pulse == 1) {
            var delta = m_ctl.get_sensor_value(obj, id, 0) * 0.1;
            CAMERA_OFFSET[1] += CAMERA_OFFSET[1]*delta;
            CAMERA_OFFSET[2] += CAMERA_OFFSET[2]*delta;
            if (CAMERA_OFFSET[1] > 4) {
                if (m_cam.is_eye_camera(camera)) {
                    m_cons.append_semi_soft_cam(camera, _character, CAMERA_OFFSET);
                } 
              

            } else {
                CAMERA_OFFSET[1] = 4;
                CAMERA_OFFSET[2] = 1.5;
            }

        }
    };

    m_ctl.create_sensor_manifold(camera, "CAMERA_OFFSET", m_ctl.CT_TRIGGER, 
        [mouse_zoom], null, zoom_cb);
}


    function setup_targetCamera() {
        var camera = m_scs.get_active_camera();

        var main_canvas = m_cont.get_canvas();
        var _vec3_tmp  = new Float32Array(3);
        main_canvas.addEventListener('mousedown', function (event) {
            event.preventDefault();
            if( event.buttons === 1 && event.button === 1 ) {

                
                var pivot = m_trans.get_translation(_character);
                m_cons.remove(camera);
                 m_cam.target_setup(camera, { pos: null, pivot: pivot});
                  m_app.enable_camera_controls();
                  
            } else {
                var pivot = m_trans.get_translation(_character);
                m_vec3.add(pivot, CAMERA_OFFSET, _vec3_tmp);
                console.log(pivot, CAMERA_OFFSET, _vec3_tmp);
                m_cons.remove(camera);
                m_cam.eye_setup(camera, {pos: _vec3_tmp, look_at: null});
                m_app.enable_camera_controls();
                // var angle = m_cam.get_camera_angles(camera);
                //   m_phy.character_rotation_inc(_character, angle[0], 0);
            }
        }, false);
         main_canvas.addEventListener('mouseup', function (event) {
               event.preventDefault();

                 var pivot = m_trans.get_translation(_character);
                m_vec3.add(pivot, CAMERA_OFFSET, _vec3_tmp);
                  m_app.disable_camera_controls();
                 m_cam.eye_setup(camera, {pos: _vec3_tmp, look_at: null});
                 m_cons.append_semi_soft_cam(camera, _character, CAMERA_OFFSET);
            
        }, false);
    }
});
b4w.require("game_example_main").init();
    
</script>
</body>
</html>